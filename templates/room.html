<!DOCTYPE html>
<html>
<head>
  <title>Oda: {{ room_id }} | SwipeTogether</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
  <style>
    body { font-family: sans-serif; margin:0; background: #f4f7fa; }
    .flex { display: flex; gap: 30px; margin: 30px; }
    .chat { width: 300px; background: #fff; border-radius: 10px; box-shadow: 0 2px 12px #0001; padding: 20px; display: flex; flex-direction: column; height: 420px; }
    .messages { flex:1; overflow-y: auto; margin-bottom: 10px; }
    .chat-form { display: flex; gap: 8px; }
    .chat-input { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #2563eb; }
    .video-box { background: #fff; border-radius: 10px; box-shadow: 0 2px 12px #0001; padding: 14px; }
    video { width: 640px; border-radius: 8px; border: 2px solid #2563eb; background: #222; }
    .main-btn { background: #2563eb; color: #fff; border: none; font-size: 1.15em; padding: 12px 22px; border-radius: 9px; cursor: pointer; margin-bottom: 12px; }
    .main-btn:hover { background: #1e40af; }
    .share-link { font-size: 13px; color: #444; margin-top: 6px; }
  </style>
</head>
<body>
  <div style="background:#2563eb;color:#fff;padding:16px;font-size:1.5em;font-weight:bold;">SwipeTogether — Oda: {{ room_id }}</div>
  <div class="flex">
    <div class="video-box">
      <video id="screen" autoplay playsinline controls></video>
      <div>
        <button class="main-btn" onclick="startScreen()" id="shareBtn">Ekranını Paylaş</button>
      </div>
      <div class="share-link">
        Oda linki: <b id="roomlink"></b>
      </div>
    </div>
    <div class="chat">
      <h3>Sohbet</h3>
      <div class="messages" id="messages"></div>
      <form class="chat-form" onsubmit="sendChat(event)">
        <input id="chatInput" class="chat-input" placeholder="Mesaj yaz..." autocomplete="off">
        <button class="main-btn" type="submit">Gönder</button>
      </form>
    </div>
  </div>
  <script>
    const room = "{{ room_id }}";
    const socket = io();
    document.getElementById("roomlink").innerText = window.location.href;
    let isSharing = false;
    let peers = {}; // {socketId: peer}
    let myStream = null;
    let isScreenSharer = false;

    // Odaya katıldığını bildir
    socket.emit("join", { room });

    // Diğer kullanıcılar odaya katıldığında ekran paylaşımı yapan varsa ona haber ver
    socket.on("user-joined", ({ sid }) => {
      if (isScreenSharer && myStream) {
        // Yeni katılan izleyiciye ekranı paylaş
        let peer = new SimplePeer({ initiator: true, trickle: false, stream: myStream });
        peers[sid] = peer;
        peer.on("signal", signal => {
          socket.emit("signal", { room, signal, target: sid });
        });
        // Peer ile bağlantı kurulduğunda bir şey yapmaya gerek yok
      }
    });

    // Signal mesajı geldiğinde peer'ı oluştur veya mevcutsa ona ilet
    socket.on("signal", data => {
      let sid = data.sid || data.target; // sinyal gönderenin veya hedefin id'si
      if (!peers[sid]) {
        // Ekran izleyici peer'ı (stream istemez)
        let peer = new SimplePeer({ initiator: false, trickle: false });
        peers[sid] = peer;
        peer.on("signal", signal => {
          socket.emit("signal", { room, signal, target: sid });
        });
        peer.on("stream", stream => {
          document.getElementById("screen").srcObject = stream;
        });
        peer.on("error", err => alert("Peer error: " + err));
        peer.signal(data.signal);
      } else {
        peers[sid].signal(data.signal);
      }
    });

    // Ekran paylaşımı başlat
    function startScreen() {
      if (isSharing) return;
      navigator.mediaDevices.getDisplayMedia({ video: true, audio: false }).then(stream => {
        myStream = stream;
        isSharing = true;
        isScreenSharer = true;
        document.getElementById("screen").srcObject = stream;
        document.getElementById("shareBtn").disabled = true;
        // Odaya bağlı diğer herkese ekranı paylaş
        socket.emit("get-users", { room });
        // Herkes için peer oluştur
        socket.on("user-joined", ({ sid }) => {
          if (sid === socket.id) return;
          let peer = new SimplePeer({ initiator: true, trickle: false, stream });
          peers[sid] = peer;
          peer.on("signal", signal => {
            socket.emit("signal", { room, signal, target: sid });
          });
        });
      }).catch(e => alert("Ekran paylaşımı başlatılamadı: " + e));
    }

    // Chat
    function sendChat(e) {
      e.preventDefault();
      const msg = document.getElementById("chatInput").value;
      if (msg.trim()) {
        socket.emit("chat", { room, msg });
        appendMsg("Sen", msg);
        document.getElementById("chatInput").value = "";
      }
    }
    socket.on("chat", data => {
      appendMsg("Diğer", data.msg);
    });

    function appendMsg(from, text) {
      const msgBox = document.getElementById("messages");
      const div = document.createElement("div");
      div.innerHTML = `<b>${from}:</b> ${text}`;
      msgBox.appendChild(div);
      msgBox.scrollTop = msgBox.scrollHeight;
    }
  </script>
</body>
</html>