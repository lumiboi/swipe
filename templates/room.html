<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Oda: {{ room_id }} | SwipeTogether</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
  <style>body { font-family:Arial; }</style>
</head>
<body>
  <div id="info" style="color:red;margin-bottom:10px;"></div>
  <video id="screen" autoplay playsinline controls style="width:100%;max-width:600px;"></video>
  <div>
    <button onclick="startScreen()" id="shareBtn">Ekranını Paylaş</button>
    <button onclick="stopScreen()" id="stopBtn" style="display:none;">Yayını Sonlandır</button>
  </div>
  <script>
    // ICE servers ve socket kodların aynı şekilde bırakabilirsin
    const ICE_SERVERS = [
      { urls: "stun:stun.relay.metered.ca:80" },
      { urls: "turn:standard.relay.metered.ca:80", username: "1d314db62543883bb998dd93", credential: "9k8DwsDoeoJUikJP" },
      { urls: "turn:standard.relay.metered.ca:80?transport=tcp", username: "1d314db62543883bb998dd93", credential: "9k8DwsDoeoJUikJP" },
      { urls: "turn:standard.relay.metered.ca:443", username: "1d314db62543883bb998dd93", credential: "9k8DwsDoeoJUikJP" },
      { urls: "turns:standard.relay.metered.ca:443?transport=tcp", username: "1d314db62543883bb998dd93", credential: "9k8DwsDoeoJUikJP" }
    ];
    let myStream = null;
    let isSharing = false;
    function isScreenShareSupportedMobile() {
      return typeof navigator.mediaDevices?.getDisplayMedia === "function";
    }
    function info(msg) {
      document.getElementById("info").innerHTML = msg;
    }
    window.onload = function() {
      if (!isScreenShareSupportedMobile()) {
        info(
          "Mobil tarayıcıda ekran paylaşımı desteklenmiyor ya da kısıtlı olabilir. <br>" +
          "<b>Android için Chrome 122+ veya iOS 17+ Safari kullanın.</b><br>" +
          "Alternatif: <button id='uploadBtn'>Video Yükle</button>"
        );
        document.getElementById("shareBtn").disabled = true;
        document.getElementById("uploadBtn")?.addEventListener("click", function() {
          let input = document.createElement("input");
          input.type = "file"; input.accept="video/*";
          input.onchange = e => {
            let file = e.target.files[0];
            if (file) {
              let url = URL.createObjectURL(file);
              document.getElementById("screen").src = url;
              info("Video yüklendi. (Gerçek ekran paylaşımı değildir.)");
            }
          };
          input.click();
        });
      } else {
        info("Mobilde ekran paylaşımı destekleniyorsa bu cihazda çalışacaktır.<br>Android Chrome 122+ veya iOS 17+ Safari önerilir.");
      }
    };
    function startScreen() {
      if (isSharing) return;
      if (!isScreenShareSupportedMobile()) {
        alert("Ekran paylaşımı desteklenmiyor.");
        return;
      }
      navigator.mediaDevices.getDisplayMedia({ video:true, audio:true }).then(stream=>{
        myStream = stream;
        isSharing = true;
        document.getElementById("screen").srcObject = stream;
        document.getElementById("shareBtn").disabled = true;
        document.getElementById("stopBtn").style.display = "";
        stream.getTracks().forEach(track=>{
          track.onended = stopScreen;
        });
      }).catch(e=>{
        info("Ekran paylaşımı başlatılamadı:<br><b>"+(e.message||e)+"</b>");
      });
    }
    function stopScreen() {
      if (myStream) myStream.getTracks().forEach(track=>track.stop());
      myStream = null; isSharing = false;
      document.getElementById("screen").srcObject = null;
      document.getElementById("shareBtn").disabled = false;
      document.getElementById("stopBtn").style.display = "none";
    }
  </script>
</body>
</html>
