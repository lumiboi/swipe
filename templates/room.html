<!DOCTYPE html>
<html>
<head>
  <title>Oda: {{ room_id }} | SwipeTogether</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
  <style>
    body { font-family: sans-serif; margin:0; background: #f4f7fa; }
    .flex { display: flex; gap: 30px; margin: 30px; }
    .chat { width: 300px; background: #fff; border-radius: 10px; box-shadow: 0 2px 12px #0001; padding: 20px; display: flex; flex-direction: column; height: 420px; }
    .messages { flex:1; overflow-y: auto; margin-bottom: 10px; }
    .chat-form { display: flex; gap: 8px; }
    .chat-input { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #2563eb; }
    .video-box { background: #fff; border-radius: 10px; box-shadow: 0 2px 12px #0001; padding: 14px; }
    video { width: 640px; border-radius: 8px; border: 2px solid #2563eb; background: #222; }
    .main-btn { background: #2563eb; color: #fff; border: none; font-size: 1.15em; padding: 12px 22px; border-radius: 9px; cursor: pointer; margin-bottom: 12px; }
    .main-btn:hover { background: #1e40af; }
    .share-link { font-size: 13px; color: #444; margin-top: 6px; }
    .username-bar { background: #2563eb; color: #fff; padding: 8px 22px; font-size: 1em; border-radius: 0 0 12px 12px; }
  </style>
</head>
<body>
  <div style="background:#2563eb;color:#fff;padding:16px;font-size:1.5em;font-weight:bold;">SwipeTogether — Oda: {{ room_id }}</div>
  <div id="usernameBar" class="username-bar"></div>
  <div class="flex">
    <div class="video-box">
      <video id="screen" autoplay playsinline controls></video>
      <div>
        <button class="main-btn" onclick="startScreen()" id="shareBtn">Ekranını Paylaş</button>
      </div>
      <div class="share-link">
        Oda linki: <b id="roomlink"></b>
      </div>
    </div>
    <div class="chat">
      <h3>Sohbet</h3>
      <div class="messages" id="messages"></div>
      <form class="chat-form" onsubmit="sendChat(event)">
        <input id="chatInput" class="chat-input" placeholder="Mesaj yaz..." autocomplete="off">
        <button class="main-btn" type="submit">Gönder</button>
      </form>
    </div>
  </div>
  <script>
    // Metered.ca ICE sunucun ile tam entegre!
    const ICE_SERVERS = [
      { urls: "stun:stun.relay.metered.ca:80" },
      {
        urls: "turn:standard.relay.metered.ca:80",
        username: "1d314db62543883bb998dd93",
        credential: "9k8DwsDoeoJUikJP",
      },
      {
        urls: "turn:standard.relay.metered.ca:80?transport=tcp",
        username: "1d314db62543883bb998dd93",
        credential: "9k8DwsDoeoJUikJP",
      },
      {
        urls: "turn:standard.relay.metered.ca:443",
        username: "1d314db62543883bb998dd93",
        credential: "9k8DwsDoeoJUikJP",
      },
      {
        urls: "turns:standard.relay.metered.ca:443?transport=tcp",
        username: "1d314db62543883bb998dd93",
        credential: "9k8DwsDoeoJUikJP",
      }
    ];

    const room = "{{ room_id }}";
    document.getElementById("roomlink").innerText = window.location.href;

    // KULLANICI ADI
    let username = localStorage.getItem("swipetogether_username");
    while (!username) {
      username = prompt("Odaya girmek için adını yaz:");
      if (username) {
        localStorage.setItem("swipetogether_username", username);
      }
    }
    document.getElementById("usernameBar").innerText = "Kullanıcı adın: " + username;

    const socket = io();
    let myStream = null;
    let isScreenSharer = false;
    let isSharing = false;
    let peers = {}; // {socketId: peer}

    let mySocketId = null;
    socket.on("connect", () => {
      mySocketId = socket.id;
    });

    // Odaya katıldığını bildir
    socket.emit("join", { room, username });

    // Ekran paylaşan kişi için: yeni biri gelirse onun için peer oluştur (initiator:true)
    socket.on("user-joined", ({ sid }) => {
      if (isScreenSharer && myStream && sid !== mySocketId && !peers[sid]) {
        let peer = new SimplePeer({
          initiator: true,
          trickle: false,
          stream: myStream,
          config: { iceServers: ICE_SERVERS }
        });
        peers[sid] = peer;
        peer.on("signal", signal => {
          socket.emit("signal", { room, signal, target: sid });
        });
        peer.on("error", err => {
          console.error("Peer error (initiator):", err);
        });
      }
    });

    // Sinyal geldiğinde: İzleyici ise peer aç (initiator:false)
    socket.on("signal", data => {
      let sid = data.sid || data.target;
      if (!peers[sid]) {
        let peer = new SimplePeer({
          initiator: false,
          trickle: false,
          config: { iceServers: ICE_SERVERS }
        });
        peers[sid] = peer;
        peer.on("signal", signal => {
          socket.emit("signal", { room, signal, target: sid });
        });
        peer.on("stream", stream => {
          document.getElementById("screen").srcObject = stream;
        });
        peer.on("error", err => {
          console.error("Peer error (viewer):", err);
        });
        peer.signal(data.signal);
      } else {
        peers[sid].signal(data.signal);
      }
    });

    function startScreen() {
      if (isSharing) return;
      navigator.mediaDevices.getDisplayMedia({ video: true, audio: false }).then(stream => {
        myStream = stream;
        isSharing = true;
        isScreenSharer = true;
        document.getElementById("screen").srcObject = stream;
        document.getElementById("shareBtn").disabled = true;
        socket.emit("get-users", { room });
      }).catch(e => alert("Ekran paylaşımı başlatılamadı: " + e));
    }

    // CHAT
    function sendChat(e) {
      e.preventDefault();
      const msg = document.getElementById("chatInput").value;
      if (msg.trim()) {
        socket.emit("chat", { room, msg, username });
        document.getElementById("chatInput").value = "";
      }
    }
    socket.on("chat", data => {
      appendMsg(data.username || "Diğer", data.msg, data.sid === mySocketId);
    });

    function appendMsg(from, text, isMe) {
      const msgBox = document.getElementById("messages");
      const div = document.createElement("div");
      div.innerHTML = `<b>${from}${isMe ? " (Sen)" : ""}:</b> ${text}`;
      msgBox.appendChild(div);
      msgBox.scrollTop = msgBox.scrollHeight;
    }
  </script>
</body>
</html>
